name: Minify Corpus

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to test'
        required: true
        default: 'main'
        type: string

jobs:
  generate_results:
    name: Minify Corpus
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        python: ["python2.7", "python3.3", "python3.4", "python3.5", "python3.6", "python3.7", "python3.8", "python3.9", "python3.10", "python3.11"]
    container:
      image: danielflook/python-minifier-build:${{ matrix.python }}-2022-10-25
      volumes:
        - /corpus:/corpus
        - /corpus-results:/corpus-results
    steps:
      - name: Checkout tests
        uses: actions/checkout@v3

      - name: Checkout ref
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.ref }}
          path: python-minifier

      - name: Install ref
        run: |
          VERSION=0.0.0
          sed -i "s/setup_requires=.*/version='$VERSION',/; s/use_scm_version=.*//" python-minifier/setup.py
          ${{matrix.python}} python-minifier/setup.py install
          (cd python-minifier && git log --pretty=format:'%H' -n 1) > ../sha.txt
          rm -rf python-minifier

      - name: Run tests
        run: |
          ${{matrix.python}} corpus_test/generate_results.py /corpus /corpus-results $(<sha.txt)

  generate_report:
    name: Generate Report
    needs: generate_results
    runs-on: self-hosted
    container:
      image: danielflook/python-minifier-build:python3.11-2022-10-25
      volumes:
        - /corpus-results:/corpus-results
    if: ${{ always() }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Checkout ref
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.ref }}
          path: python-minifier

      - name: Install ref
        run: |
          (cd python-minifier && git log --pretty=format:'%H' -n 1) > ../sha.txt
          rm -rf python-minifier

      - name: Run tests
        run: |
          python3.11 corpus_test/generate_report.py /corpus-results ${{ inputs.ref }} $(<sha.txt) >> $GITHUB_STEP_SUMMARY
